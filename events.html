<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Venuu - Discover Amazing Events</title>

    <!-- External Libraries -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Rubik+Mono+One&display=swap"
      rel="stylesheet"
    />

    <!-- Compiled Tailwind CSS -->
    <link rel="stylesheet" href="css/output.css" />
  </head>

  <body class="bg-background text-gray-900 font-sans">
    <!-- Navigation -->
    <nav class="nav" role="navigation" aria-label="Main navigation">
      <div class="flex justify-between items-center w-full">
        <a
          href="index.html"
          class="flex items-center"
          aria-label="Venuu - Go to homepage"
        >
          <div id="lottie-logo" class="nav-logo"></div>
        </a>

        <!-- Desktop Navigation -->
        <div class="nav-links hidden md:flex">
          <a
            data-draw-line
            href="events.html"
            class="text-draw nav-link active"
          >
            <p class="text-draw__p">Events</p>
            <div data-draw-line-box class="text-draw__box"></div>
          </a>
          <a data-draw-line href="favorites.html" class="text-draw nav-link">
            <p class="text-draw__p">Favorites</p>
            <div data-draw-line-box class="text-draw__box"></div>
          </a>
          <a
            data-draw-line
            data-open-create-modal
            href="#"
            class="text-draw nav-link"
          >
            <p class="text-draw__p">Create Events</p>
            <div data-draw-line-box class="text-draw__box"></div>
          </a>
          <a data-draw-line href="login.html" class="text-draw nav-link">
            <p class="text-draw__p">Login</p>
            <div data-draw-line-box class="text-draw__box"></div>
          </a>
        </div>

        <!-- Mobile Menu Button -->
        <button
          id="mobile-menu-btn"
          class="mobile-menu-btn md:hidden"
          aria-label="Toggle mobile menu"
        >
          <i class="fas fa-bars text-xl"></i>
        </button>
      </div>
    </nav>

    <!-- Search and Filter Section -->
    <div class="search-section">
      <div class="search-filter-container">
        <!-- Search Bar with Autocomplete -->
        <div style="width: 407px; margin-bottom: 1.5rem; position: relative">
          <div
            style="
              display: flex;
              width: 100%;
              height: 30px;
              padding: 0 32px;
              flex-direction: row;
              justify-content: flex-start;
              align-items: center;
              flex-shrink: 0;
              border-radius: 25px;
              border: 0.5px solid #6b6666;
              background: #fff;
              box-sizing: border-box;
              overflow: hidden;
            "
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              style="margin-right: 8px; flex-shrink: 0; display: block"
            >
              <path
                d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z"
                stroke="#6B6666"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <input
              type="text"
              id="search-input"
              placeholder="Search for events..."
              style="
                padding: 0;
                margin: 0;
                height: 100%;
                flex: 1;
                min-width: 0;
                border: none;
                outline: none;
                background: transparent;
                font-size: 0.875rem;
                line-height: 1.25rem;
                box-shadow: none;
              "
              autocomplete="off"
              aria-label="Search for events"
            />
          </div>
          <!-- Autocomplete Dropdown -->
          <div
            id="search-suggestions"
            class="absolute z-10 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden"
            style="width: 407px"
          >
            <div class="py-2">
              <div class="px-4 py-2 text-sm text-gray-500">Recent searches</div>
              <div id="suggestions-list" class="max-h-48 overflow-y-auto"></div>
            </div>
          </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-buttons-container">
          <!-- Category Filter -->
          <div>
            <select
              id="category-filter"
              class="filter-button"
              aria-label="Filter by category"
            >
              <option value="">All Categories</option>
              <!-- Options will be populated dynamically from API data -->
            </select>
          </div>

          <!-- Location Filter -->
          <div>
            <select
              id="location-filter"
              class="filter-button"
              aria-label="Filter by location"
            >
              <option value="">All Locations</option>
              <!-- Options will be populated dynamically from API data -->
            </select>
          </div>

          <!-- Sort Filter -->
          <div>
            <select
              id="sort-filter"
              class="filter-button"
              aria-label="Sort events"
            >
              <option value="">Default</option>
              <option value="date-asc">Date (Earliest)</option>
              <option value="date-desc">Date (Latest)</option>
              <option value="title-asc">Title (A-Z)</option>
              <option value="title-desc">Title (Z-A)</option>
            </select>
          </div>

          <!-- Clear Filters -->
          <div>
            <button
              id="clear-filters"
              class="filter-button bg-white hover:bg-red-50 hover:border-red-400 hover:text-red-600 cursor-pointer transition-all"
              aria-label="Clear all filters"
            >
              Clear All
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                class="ml-1"
              >
                <path
                  d="M10.5 3.5L3.5 10.5M3.5 3.5L10.5 10.5"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Events Section -->
    <section id="events-section" class="events-container">
      <div class="events-grid" id="events-grid">
        <!-- Event cards will be loaded here -->
      </div>

      <!-- Load More Button -->
      <div class="load-more-container mt-8">
        <button id="load-more-btn" class="load-more-btn">
          <img
            src="./Images/Images_and_lottie/svg/LOADMOREICON.svg"
            alt="Load more"
            width="32"
            height="32"
          />
          <img
            src="./Images/Images_and_lottie/svg/LOADMOREICON.svg"
            alt="Load more"
            width="32"
            height="32"
          />
        </button>
      </div>

      <!-- Results Count -->
      <div class="mt-6 text-center">
        <p id="results-count" class="text-gray-600 text-sm font-medium"></p>
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer" id="contact" role="contentinfo">
      <div class="footer-content">
        <div class="footer-section">
          <a data-draw-line href="#" class="text-draw">
            <h3 class="tit text-draw__p">Contact</h3>
            <div data-draw-line-box class="text-draw__box"></div>
          </a>
          <address class="mb-2 not-italic">
            <p>Reykjavik, Iceland</p>
            <p>
              <a href="mailto:info@venuu.is">info@venuu.is</a>
            </p>
            <p>
              <a href="tel:+3541234567">+354 123 4567</a>
            </p>
            <div class="social-media-icons">
              <a href="#" aria-label="Facebook">
                <svg
                  width="10"
                  height="20"
                  viewBox="0 0 10 20"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M6.5 6.5V4.5C6.5 3.7 7.2 3 8 3H9.5V0H6.5C4.6 0 3 1.6 3 3.5V6.5H0V10H3V20H6.5V10H9.5L10 6.5H6.5Z"
                    fill="#333333"
                  />
                </svg>
              </a>
              <a href="#" aria-label="Instagram">
                <svg
                  width="19"
                  height="19"
                  viewBox="0 0 19 19"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M9.5 0C4.3 0 0 4.3 0 9.5S4.3 19 9.5 19 19 14.7 19 9.5 14.7 0 9.5 0ZM9.5 16.2C6.1 16.2 3.3 13.4 3.3 9.5S6.1 2.8 9.5 2.8 15.7 5.6 15.7 9.5 12.9 16.2 9.5 16.2Z"
                    fill="#333333"
                  />
                  <circle cx="9.5" cy="9.5" r="2.8" fill="#333333" />
                  <circle cx="14.6" cy="4.4" r="0.7" fill="#333333" />
                </svg>
              </a>
              <a href="#" aria-label="Twitter">
                <svg
                  width="23"
                  height="19"
                  viewBox="0 0 23 19"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M23 2.3C22.1 2.7 21.2 2.9 20.2 3C21.2 2.4 22 1.5 22.4 0.4C21.5 1 20.4 1.3 19.3 1.5C18.5 0.6 17.3 0 16 0C13.4 0 11.3 2.1 11.3 4.7C11.3 5.1 11.3 5.4 11.4 5.8C7.5 5.6 4 3.7 1.6 0.9C1.2 1.5 1 2.3 1 3.1C1 4.6 1.8 5.9 3 6.6C2.3 6.6 1.6 6.4 1 6.1V6.2C1 8.4 2.6 10.2 4.7 10.6C4.3 10.7 3.9 10.8 3.4 10.8C3.1 10.8 2.8 10.7 2.5 10.7C3.1 12.4 4.7 13.6 6.6 13.6C5.1 14.7 3.2 15.3 1.2 15.3C0.8 15.3 0.4 15.3 0 15.2C2 16.4 4.4 17.1 6.9 17.1C16 17.1 20.8 10.9 20.8 5.2C20.8 5 20.8 4.8 20.8 4.6C21.8 4 22.7 3.2 23.4 2.3L23 2.3Z"
                    fill="#333333"
                  />
                </svg>
              </a>
            </div>
          </address>
        </div>
        <div class="footer-section">
          <a data-draw-line href="#" class="text-draw">
            <h3 class="tit text-draw__p">About</h3>
            <div data-draw-line-box class="text-draw__box"></div>
          </a>
          <p>
            Venuu connects people through Iceland's vibrant cultural events.
          </p>
          <p>2025 Venuu. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <!-- Lottie Web Library -->
    <script src="node_modules/lottie-web/build/player/lottie.min.js"></script>

    <!-- GSAP Library -->
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/DrawSVGPlugin.min.js"></script>

    <!-- Draw Underline Effect -->
    <script type="module">
      import { initDrawRandomUnderline } from "./js/draw-underline.js";
      window.initDrawRandomUnderline = initDrawRandomUnderline;
    </script>

    <!-- Events page uses inline JavaScript for filtering -->
    <!-- Shared TypeScript is not needed here -->

    <script>
      /**
       * Initialize Create Event Modal functionality
       */
      function initCreateEventModal() {
        const modal = document.getElementById("create-event-modal");
        const openButtons = document.querySelectorAll(
          "a[data-open-create-modal]"
        );
        const closeButton = document.getElementById("create-event-modal-close");
        const form = document.getElementById("create-event-form");

        // Open modal
        function openModal() {
          modal.style.display = "flex";
          document.body.style.overflow = "hidden";
          // Focus on first input
          const firstInput = modal.querySelector("input");
          if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
          }
        }

        // Close modal
        function closeModal() {
          modal.style.display = "none";
          document.body.style.overflow = "";
          // Reset form
          if (form) {
            form.reset();
          }
        }

        // Event listeners for opening modal
        openButtons.forEach((button) => {
          button.addEventListener("click", (e) => {
            // Double check that this is the Create Events button
            const buttonText = button.textContent.trim();
            if (buttonText.includes("Create Events")) {
              e.preventDefault();
              openModal();
            }
          });
        });

        // Event listener for closing modal
        if (closeButton) {
          closeButton.addEventListener("click", (e) => {
            e.preventDefault();
            closeModal();
          });
        }

        // Close modal when clicking outside
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            closeModal();
          }
        });

        // Close modal with Escape key
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && modal.style.display !== "none") {
            closeModal();
          }
        });

        // Handle form submission
        if (form) {
          form.addEventListener("submit", (e) => {
            e.preventDefault();

            // Get form data
            const formData = new FormData(form);
            const eventData = {
              title: formData.get("title"),
              date: formData.get("date"),
              time: formData.get("time"),
              location: formData.get("location"),
              fee: formData.get("fee"),
              image: formData.get("image"),
              description: formData.get("description"),
            };

            // Log the event data (in a real app, you'd send this to a server)
            console.log("Event created:", eventData);

            // Show success message (you could replace this with a toast notification)
            alert("Event created successfully!");

            // Close modal
            closeModal();
          });
        }
      }

      // Wait for DOM to be fully loaded
      document.addEventListener("DOMContentLoaded", function () {
        /**
         * Initialize VENUU logo animation using Lottie Web
         */
        function initializeLogoAnimation() {
          try {
            const logoContainer = document.getElementById("lottie-logo");
            if (!logoContainer) {
              console.error("Logo container not found");
              return;
            }

            // Check if Lottie library is loaded
            if (!window.lottie) {
              console.error("Lottie library not loaded");
              showFallbackLogo(logoContainer);
              return;
            }

            // Try multiple possible paths for the Logo.json file
            const possiblePaths = [
              "./Images/Images_and_lottie/Logo.json",
              "Images/Images_and_lottie/Logo.json",
              "/Images/Images_and_lottie/Logo.json",
              "./images/Images_and_lottie/Logo.json",
              "images/Images_and_lottie/Logo.json"
            ];

            let animationLoaded = false;
            let currentPathIndex = 0;

            function tryLoadAnimation() {
              if (currentPathIndex >= possiblePaths.length) {
                console.error("All logo paths failed to load");
                showFallbackLogo(logoContainer);
                return;
              }

              const currentPath = possiblePaths[currentPathIndex];
              console.log(`Trying to load logo from: ${currentPath}`);

              const animation = window.lottie.loadAnimation({
                container: logoContainer,
                renderer: "svg",
                loop: true,
                autoplay: true,
                path: currentPath,
              });

              // Add comprehensive error handling
              animation.addEventListener("data_failed", function () {
                console.error(`Failed to load Lottie animation from: ${currentPath}`);
                currentPathIndex++;
                tryLoadAnimation();
              });

              animation.addEventListener("data_ready", function () {
                console.log(`Successfully loaded logo from: ${currentPath}`);
                animationLoaded = true;
              });

              // Set a timeout to try next path if no response
              setTimeout(() => {
                if (!animationLoaded) {
                  console.error(`Timeout loading logo from: ${currentPath}`);
                  currentPathIndex++;
                  tryLoadAnimation();
                }
              }, 3000);
            }

            tryLoadAnimation();

          } catch (error) {
            console.error("Error loading logo animation:", error);
            const logoContainer = document.getElementById("lottie-logo");
            if (logoContainer) {
              showFallbackLogo(logoContainer);
            }
          }
        }

        /**
         * Show fallback logo when Lottie animation fails
         */
        function showFallbackLogo(container) {
          container.innerHTML = `
            <div style="
              font-family: 'Rubik Mono One', monospace; 
              font-size: 24px; 
              font-weight: bold; 
              color: #340aff;
              display: flex;
              align-items: center;
              justify-content: center;
              height: 100%;
              width: 100%;
            ">VENUU</div>
          `;
        }

        // Initialize logo
        initializeLogoAnimation();

        /**
         * Array of available poster images
         */
        const posterImages = [
          "068e9d4bef717cd1000843dc38c603ec.jpg",
          "1d595e6dc1b6a3d963b932eb94de79d1.jpg",
          "233986128f46951bf66a727cca1b3a18.jpg",
          "24de6470d3365d85550c2c65ce8ddfca.jpg",
          "3bd777f8c2760cbf585251808e738698.jpg",
          "3f117cff666f231104f270edda727dab.jpg",
          "53fe06b8e5fe6593f0f2a5de835609d2.jpg",
          "542dfd6b879d676a823e611028e40984.jpg",
          "783d478fde50b0f1d23ed5db8e9e2dee.jpg",
          "90f82bfbdb111074fdfe5c1a6d813f5e.jpg",
          "9303687a932a721b3a360633ade52260.jpg",
          "96ec819f4ad7e5237c653c05baf5cd8c.jpg",
          "b365df6222f9cce1e0ec0bf2ee881fb9.jpg",
          "b3a1e66d241d956c3de527627d3c0a8a.jpg",
          "d7ecf3fce251c523f3bb43ee6620e902.jpg",
          "istockphoto-1478375497-612x612.jpg",
          "istockphoto-494896581-612x612.jpg",
          "pexels-jibarofoto-2774556.jpg",
          "Poster.jpg",
        ];

        // Global variables for event management
        let allEvents = [];
        let filteredEvents = [];
        let displayedEvents = 0;
        const eventsPerLoad = 12; // 4 rows × 3 columns = 12 events per load
        let searchTimeout = null;
        let recentSearches = JSON.parse(
          localStorage.getItem("recentSearches") || "[]"
        );

        // Filter state management
        let currentFilters = {
          search: "",
          category: "",
          location: "",
          sort: "",
        };

        // Store available filter options
        let availableCategories = new Set();
        let availableLocations = new Set();

        /**
         * Create HTML for an event card matching the main page style
         */
        function createEventCard(event) {
          const title =
            (event.language && event.language.en && event.language.en.title) ||
            event.title ||
            event.title_en ||
            "Untitled";
          const date = event.start
            ? new Date(event.start).toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
              })
            : "";
          const location =
            (event.language && event.language.en && event.language.en.place) ||
            event.formatted_address ||
            event.city ||
            "";

          // Use actual event image if available, otherwise use random poster
          let image;
          if (event.event_image && event.event_image.startsWith("/media/")) {
            // Use the actual event image from the API
            image = `https://api.venuu.is${event.event_image}`;
          } else if (
            event.event_thumbnail &&
            event.event_thumbnail.startsWith("/media/")
          ) {
            // Fallback to thumbnail
            image = `https://api.venuu.is${event.event_thumbnail}`;
          } else {
            // Randomly select a poster image as fallback
            const randomPoster =
              posterImages[Math.floor(Math.random() * posterImages.length)];
            image = `./Images/posters/${randomPoster}`;
          }

          // Card markup
          return `
        <div class="event-item" data-event='${JSON.stringify(event).replace(
          /'/g,
          "&#39;"
        )}'>
          <img src="${image}" alt="${title}" loading="lazy" onerror="this.src='./Images/posters/${posterImages[Math.floor(Math.random() * posterImages.length)]}'" />
          <div class="event-content flex flex-col p-4 gap-1.5">
            <div class="event-title">${title}</div>
                            <div class="event-date-row">
              <div class="date-section">
                <svg class="calendar-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                  <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2"/>
                  <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2"/>
                  <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                <div class="event-date">${date}</div>
                                </div>
              <svg class="heart-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
            <div class="event-location">${location}</div>
                    </div>
                </div>
        `;
        }

        /**
         * Debounced search function
         */
        function debouncedSearch(searchTerm) {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            currentFilters.search = searchTerm;
            applyAllFilters();
          }, 300);
        }

        /**
         * Apply all filters and sorting
         */
        function applyAllFilters() {
          console.log("=== Applying filters ===");
          console.log("Current filters:", currentFilters);
          console.log("Total events before filtering:", allEvents.length);
          let filtered = [...allEvents];

          // Search filter
          if (currentFilters.search && currentFilters.search.trim() !== "") {
            const beforeCount = filtered.length;
            const term = currentFilters.search.toLowerCase().trim();
            filtered = filtered.filter((event) => {
              const title =
                (event.language &&
                  event.language.en &&
                  event.language.en.title) ||
                event.title ||
                event.title_en ||
                "";
              let location = "";
              if (event.postal && event.city) {
                location = `${event.postal} ${event.city}`;
              } else if (event.city) {
                location = event.city;
              } else if (event.formatted_address) {
                const addressParts = event.formatted_address.split(", ");
                if (addressParts.length >= 2) {
                  location = addressParts[addressParts.length - 1];
                } else {
                  location = event.formatted_address;
                }
              }
              const tags = (event.tags || []).join(" ").toLowerCase();

              return (
                title.toLowerCase().includes(term) ||
                location.toLowerCase().includes(term) ||
                tags.includes(term)
              );
            });
            console.log(
              `Search filter "${term}": ${beforeCount} -> ${filtered.length} events`
            );
          }

          // Category filter
          if (
            currentFilters.category &&
            currentFilters.category.trim() !== ""
          ) {
            const beforeCount = filtered.length;
            filtered = filtered.filter((event) => {
              const eventCategories = event.categories || [];
              const hasCategory = eventCategories.some(
                (category) =>
                  category && category.name === currentFilters.category
              );
              return hasCategory;
            });
            console.log(
              `🔍 Category filter "${currentFilters.category}": ${beforeCount} -> ${filtered.length} events`
            );
            if (filtered.length === 0 && beforeCount > 0) {
              console.warn(
                "⚠️ No events match category filter. Check if category names match exactly."
              );
            }
          }

          // Location filter
          if (
            currentFilters.location &&
            currentFilters.location.trim() !== ""
          ) {
            const beforeCount = filtered.length;
            filtered = filtered.filter((event) => {
              const postalCode = event.postal || "";
              const matches = postalCode === currentFilters.location;
              return matches;
            });
            console.log(
              `📍 Location filter "${currentFilters.location}": ${beforeCount} -> ${filtered.length} events`
            );
            if (filtered.length === 0 && beforeCount > 0) {
              console.warn(
                "⚠️ No events match location filter. Check if postal codes match exactly."
              );
            }
          }

          // Apply sorting
          if (currentFilters.sort && currentFilters.sort !== "") {
            filtered.sort((a, b) => {
              switch (currentFilters.sort) {
                case "date-asc":
                  return new Date(a.start || 0) - new Date(b.start || 0);
                case "date-desc":
                  return new Date(b.start || 0) - new Date(a.start || 0);
                case "title-asc":
                  const titleA = (
                    a.language?.en?.title ||
                    a.title ||
                    a.title_en ||
                    ""
                  ).toLowerCase();
                  const titleB = (
                    b.language?.en?.title ||
                    b.title ||
                    b.title_en ||
                    ""
                  ).toLowerCase();
                  return titleA.localeCompare(titleB);
                case "title-desc":
                  const titleA2 = (
                    a.language?.en?.title ||
                    a.title ||
                    a.title_en ||
                    ""
                  ).toLowerCase();
                  const titleB2 = (
                    b.language?.en?.title ||
                    b.title ||
                    b.title_en ||
                    ""
                  ).toLowerCase();
                  return titleB2.localeCompare(titleA2);
                default:
                  return 0;
              }
            });
            console.log(`Applied sort: ${currentFilters.sort}`);
          }

          filteredEvents = filtered;
          displayedEvents = Math.min(eventsPerLoad, filteredEvents.length); // Reset to first batch when filters change
          console.log(`=== Final result: ${filteredEvents.length} events ===`);
          displayEvents();
        }

        /**
         * Populate filter dropdowns with actual data
         */
        function populateFilterOptions() {
          console.log("Populating filter options...");

          // Extract unique categories and locations from events
          allEvents.forEach((event) => {
            // Extract categories
            if (event.categories && Array.isArray(event.categories)) {
              event.categories.forEach((cat) => {
                if (cat.name) {
                  availableCategories.add(cat.name);
                }
              });
            }

            // Extract locations (postal codes)
            if (event.postal) {
              const locationLabel = event.city
                ? `${event.postal} ${event.city}`
                : event.postal;
              availableLocations.add(
                JSON.stringify({ postal: event.postal, label: locationLabel })
              );
            }
          });

          // Populate category filter
          const categoryFilter = document.getElementById("category-filter");
          if (categoryFilter) {
            // Keep the "All Categories" option
            categoryFilter.innerHTML =
              '<option value="">All Categories</option>';

            // Add actual categories from data
            const sortedCategories = Array.from(availableCategories).sort();
            console.log("Available categories:", sortedCategories);
            sortedCategories.forEach((category) => {
              const option = document.createElement("option");
              option.value = category;
              option.textContent = category;
              categoryFilter.appendChild(option);
            });
            console.log(
              `✅ Added ${sortedCategories.length} categories to filter dropdown`
            );
          }

          // Populate location filter
          const locationFilter = document.getElementById("location-filter");
          if (locationFilter) {
            // Keep the "All Locations" option
            locationFilter.innerHTML =
              '<option value="">All Locations</option>';

            // Add actual locations from data
            const locations = Array.from(availableLocations)
              .map((loc) => JSON.parse(loc))
              .sort((a, b) => a.postal.localeCompare(b.postal));

            console.log(
              "Available locations (first 10):",
              locations.slice(0, 10)
            );
            locations.forEach((location) => {
              const option = document.createElement("option");
              option.value = location.postal;
              option.textContent = location.label;
              locationFilter.appendChild(option);
            });
            console.log(
              `✅ Added ${locations.length} postal code locations to filter dropdown`
            );
          }
        }

        /**
         * Load events from API
         */
        async function loadEvents() {
          try {
            const response = await fetch("./api-data.json");
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            if (data && Array.isArray(data)) {
              allEvents = data;
              console.log(`Loaded ${allEvents.length} events from API`);
            } else {
              console.error("Invalid API data structure:", data);
              allEvents = [];
            }

            // Populate filter dropdowns with actual data
            populateFilterOptions();

            // Initialize with limited events (first load)
            filteredEvents = [...allEvents];
            displayedEvents = Math.min(eventsPerLoad, allEvents.length); // Show only first batch
            displayEvents();
          } catch (error) {
            console.error("Error loading events:", error);
            allEvents = [];
            filteredEvents = [];
            displayedEvents = 0;
            displayEvents();
          }
        }

        /**
         * Display events in the grid with smooth animations
         */
        function displayEvents() {
          const eventsGrid = document.getElementById("events-grid");
          if (!eventsGrid) {
            console.error("Events grid not found");
            return;
          }

          const eventsToShow = filteredEvents.slice(0, displayedEvents);

          // Add smooth transition
          eventsGrid.style.opacity = "0.7";

          requestAnimationFrame(() => {
            if (eventsToShow.length === 0) {
              eventsGrid.innerHTML = `
                <div class="col-span-full text-center py-12">
                  <p class="text-gray-500 text-lg">No events found matching your filters.</p>
                  <p class="text-gray-400 text-sm mt-2">Try adjusting your filters to see more results.</p>
                </div>
              `;
            } else {
              eventsGrid.innerHTML = eventsToShow
                .map((event) => createEventCard(event))
                .join("");
            }

            eventsGrid.style.opacity = "1";
          });

          // Show/hide load more button based on remaining events
          updateLoadMoreButton();

          // Update results count
          updateResultsCount();

          // Add click event listeners to new event cards
          addEventCardListeners();
        }

        /**
         * Add click event listeners to event cards
         */
        function addEventCardListeners() {
          const eventCards = document.querySelectorAll(".event-item");
          eventCards.forEach((card) => {
            card.addEventListener("click", () => {
              const eventData = JSON.parse(card.getAttribute("data-event"));
              console.log("Event clicked:", eventData);
              // You can add navigation to event details page here
            });
          });
        }

        /**
         * Update results count display
         */
        function updateResultsCount() {
          const resultsCount = document.getElementById("results-count");
          if (resultsCount) {
            if (filteredEvents.length === 0) {
              resultsCount.textContent = "No events found";
            } else if (displayedEvents >= filteredEvents.length) {
              // Showing all available events
              if (filteredEvents.length === allEvents.length) {
                resultsCount.textContent = `Showing all ${filteredEvents.length} events`;
              } else {
                resultsCount.textContent = `Showing all ${filteredEvents.length} of ${allEvents.length} events`;
              }
            } else {
              // Showing partial results
              resultsCount.textContent = `Showing ${displayedEvents} of ${filteredEvents.length} events`;
            }
          }
        }

        /**
         * Load more events
         */
        function loadMoreEvents() {
          console.log(
            `Loading more events. Current: ${displayedEvents}, Total: ${filteredEvents.length}`
          );
          displayedEvents = Math.min(
            displayedEvents + eventsPerLoad,
            filteredEvents.length
          );
          console.log(`Now displaying: ${displayedEvents} events`);
          displayEvents();
        }

        /**
         * Show load more button loading state
         */
        function showLoadMoreLoading() {
          const loadMoreBtn = document.getElementById("load-more-btn");
          loadMoreBtn.classList.add("loading");
        }

        /**
         * Hide load more button loading state
         */
        function hideLoadMoreLoading() {
          const loadMoreBtn = document.getElementById("load-more-btn");
          loadMoreBtn.classList.remove("loading");
        }

        /**
         * Update load more button visibility
         */
        function updateLoadMoreButton() {
          const loadMoreBtn = document.getElementById("load-more-btn");
          const loadMoreContainer = document.querySelector(
            ".load-more-container"
          );

          if (!loadMoreContainer) return;

          if (displayedEvents >= filteredEvents.length) {
            loadMoreContainer.style.display = "none";
          } else {
            loadMoreContainer.style.display = "flex";
          }
        }

        /**
         * Search and filter events
         */
        function filterEvents(searchTerm) {
          // Store search term globally
          currentFilters.search = searchTerm.trim();

          // Start with all events
          let results = [...allEvents];

          // Apply search filter
          if (currentFilters.search) {
            const term = currentFilters.search.toLowerCase();
            results = results.filter((event) => {
              const title = (event.title || event.title_en || "").toLowerCase();
              const location =
                event.postal && event.city
                  ? `${event.postal} ${event.city}`.toLowerCase()
                  : (event.city || "").toLowerCase();
              const tags = (event.tags || []).join(" ").toLowerCase();

              return (
                title.includes(term) ||
                location.includes(term) ||
                tags.includes(term)
              );
            });
          }

          // Apply category filter
          if (currentFilters.category) {
            results = results.filter((event) => {
              const categories = event.categories || [];
              return categories.some(
                (cat) => cat.name === currentFilters.category
              );
            });
          }

          // Apply location filter
          if (currentFilters.location) {
            results = results.filter((event) => {
              return event.postal === currentFilters.location;
            });
          }

          // Apply sorting
          if (currentFilters.sort) {
            results.sort((a, b) => {
              switch (currentFilters.sort) {
                case "date-asc":
                  return new Date(a.start) - new Date(b.start);
                case "date-desc":
                  return new Date(b.start) - new Date(a.start);
                case "title-asc":
                  const titleA = (a.title || a.title_en || "").toLowerCase();
                  const titleB = (b.title || b.title_en || "").toLowerCase();
                  return titleA.localeCompare(titleB);
                case "title-desc":
                  const titleA2 = (a.title || a.title_en || "").toLowerCase();
                  const titleB2 = (b.title || b.title_en || "").toLowerCase();
                  return titleB2.localeCompare(titleA2);
                default:
                  return 0;
              }
            });
          }

          // Update filtered events and reset display
          filteredEvents = results;
          displayedEvents = Math.min(eventsPerLoad, filteredEvents.length);
          displayEvents();
        }

        /**
         * Add click event listeners to event cards
         */
        function addEventCardListeners() {
          const eventCards = document.querySelectorAll(".event-item");
          eventCards.forEach((card) => {
            card.addEventListener("click", (e) => {
              e.preventDefault();
              const eventData = JSON.parse(card.getAttribute("data-event"));
              // You can add modal functionality here if needed
              console.log("Event clicked:", eventData);
            });
          });
        }

        /**
         * Clear all filters
         */
        function clearAllFilters() {
          console.log("Clearing all filters...");

          // Reset filter state
          currentFilters = {
            search: "",
            category: "",
            location: "",
            sort: "",
          };

          // Reset form elements
          const categoryFilter = document.getElementById("category-filter");
          const locationFilter = document.getElementById("location-filter");
          const sortFilter = document.getElementById("sort-filter");
          const searchInput = document.getElementById("search-input");

          if (categoryFilter) categoryFilter.value = "";
          if (locationFilter) locationFilter.value = "";
          if (sortFilter) sortFilter.value = "";
          if (searchInput) searchInput.value = "";

          // Reset filtered events
          filteredEvents = [...allEvents];
          displayedEvents = Math.min(eventsPerLoad, allEvents.length); // Reset to first batch

          // Update display
          displayEvents();

          console.log("Filters cleared, showing first batch of events");
        }

        /**
         * Show search suggestions
         */
        function showSearchSuggestions() {
          const suggestionsContainer =
            document.getElementById("search-suggestions");
          const suggestionsList = document.getElementById("suggestions-list");

          if (recentSearches.length > 0) {
            suggestionsList.innerHTML = recentSearches
              .slice(0, 5)
              .map(
                (search) =>
                  `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="selectSuggestion('${search}')">${search}</div>`
              )
              .join("");
            suggestionsContainer.classList.remove("hidden");
          }
        }

        /**
         * Hide search suggestions
         */
        function hideSearchSuggestions() {
          const suggestionsContainer =
            document.getElementById("search-suggestions");
          suggestionsContainer.classList.add("hidden");
        }

        /**
         * Select search suggestion
         */
        function selectSuggestion(searchTerm) {
          document.getElementById("search-input").value = searchTerm;
          currentFilters.search = searchTerm;
          applyAllFilters();
          hideSearchSuggestions();
        }

        /**
         * Add to recent searches
         */
        function addToRecentSearches(searchTerm) {
          if (searchTerm && !recentSearches.includes(searchTerm)) {
            recentSearches.unshift(searchTerm);
            recentSearches = recentSearches.slice(0, 10); // Keep only 10 recent searches
            localStorage.setItem(
              "recentSearches",
              JSON.stringify(recentSearches)
            );
          }
        }

        // Event listeners with accessibility support
        document
          .getElementById("search-input")
          .addEventListener("input", (e) => {
            const searchTerm = e.target.value;
            debouncedSearch(searchTerm);

            if (searchTerm) {
              showSearchSuggestions();
            } else {
              hideSearchSuggestions();
            }
          });

        document.getElementById("search-input").addEventListener("blur", () => {
          setTimeout(hideSearchSuggestions, 200); // Delay to allow click on suggestions
        });

        document
          .getElementById("search-input")
          .addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              const searchTerm = e.target.value;
              addToRecentSearches(searchTerm);
              hideSearchSuggestions();
            }
          });

        document
          .getElementById("category-filter")
          .addEventListener("change", (e) => {
            console.log("Category filter changed to:", e.target.value);
            currentFilters.category = e.target.value;
            applyAllFilters();
          });

        document
          .getElementById("location-filter")
          .addEventListener("change", (e) => {
            console.log("Location filter changed to:", e.target.value);
            currentFilters.location = e.target.value;
            applyAllFilters();
          });

        document
          .getElementById("sort-filter")
          .addEventListener("change", (e) => {
            currentFilters.sort = e.target.value;
            applyAllFilters();
          });

        document
          .getElementById("clear-filters")
          .addEventListener("click", clearAllFilters);

        document
          .getElementById("load-more-btn")
          .addEventListener("click", loadMoreEvents);

        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById("mobile-menu-btn");
        if (mobileMenuBtn) {
          mobileMenuBtn.addEventListener("click", () => {
            const navLinks = document.querySelector(".nav-links");
            if (navLinks) {
              navLinks.classList.toggle("hidden");
              navLinks.classList.toggle("flex");
              navLinks.classList.toggle("flex-col");
              navLinks.classList.toggle("absolute");
              navLinks.classList.toggle("top-full");
              navLinks.classList.toggle("left-0");
              navLinks.classList.toggle("right-0");
              navLinks.classList.toggle("bg-white");
              navLinks.classList.toggle("shadow-lg");
              navLinks.classList.toggle("p-4");
              navLinks.classList.toggle("z-50");
            }
          });
        }

        // Keyboard navigation support
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            hideSearchSuggestions();
            // Close mobile menu on Escape
            const navLinks = document.querySelector(".nav-links");
            if (navLinks && !navLinks.classList.contains("hidden")) {
              navLinks.classList.add("hidden");
              navLinks.classList.remove(
                "flex",
                "flex-col",
                "absolute",
                "top-full",
                "left-0",
                "right-0",
                "bg-white",
                "shadow-lg",
                "p-4",
                "z-50"
              );
            }
          }
        });

        // Load events when page loads
        loadEvents();

        // Initialize draw random underline effect
        if (typeof initDrawRandomUnderline === "function") {
          // Add a small delay to ensure DOM is fully ready
          setTimeout(() => {
            initDrawRandomUnderline();
          }, 100);
        }

        // Initialize create event modal functionality
        initCreateEventModal();
      });
    </script>

    <!-- Create Event Modal -->
    <div
      id="create-event-modal"
      class="create-event-modal-overlay"
      style="display: none"
      aria-hidden="true"
    >
      <div class="create-event-modal-container" data-panel>
        <!-- Modal Header -->
        <div class="create-event-modal-header">
          <h2 id="create-event-modal-title" class="create-event-modal-title">
            Create the Event
          </h2>
          <button
            id="create-event-modal-close"
            class="create-event-modal-close"
            data-close
            aria-label="Close"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 6l12 12M18 6L6 18"
              />
            </svg>
          </button>
        </div>

        <!-- Modal Content -->
        <div class="create-event-modal-content">
          <form id="create-event-form" class="space-y-4">
            <!-- Title of Event -->
            <div>
              <label
                for="event-title"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Title of Event
              </label>
              <div class="relative">
                <input
                  type="text"
                  id="event-title"
                  name="title"
                  required
                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                  placeholder="Title"
                />
                <div class="absolute inset-y-0 right-0 flex items-center pr-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 text-gray-400"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </div>
              </div>
            </div>

            <!-- Date -->
            <div>
              <label
                for="event-date"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Date
              </label>
              <div class="relative">
                <input
                  type="text"
                  id="event-date"
                  name="date"
                  required
                  class="w-full px-3 py-2 pl-8 pr-8 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                  placeholder="Select the Date"
                />
                <div class="absolute inset-y-0 left-0 flex items-center pl-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 text-gray-400"
                    viewBox="0 -960 960 960"
                    fill="#e3e3e3"
                  >
                    <path
                      d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v560q0 33-23.5 56.5T760-80H200Zm0-80h560v-400H200v400Zm0-480h560v-80H200v80Zm0 0v-80 80Zm280 240q-17 0-28.5-11.5T440-440q0-17 11.5-28.5T480-480q17 0 28.5 11.5T520-440q0 17-11.5 28.5T480-400Zm-160 0q-17 0-28.5-11.5T280-440q0-17 11.5-28.5T320-480q17 0 28.5 11.5T360-440q0 17-11.5 28.5T320-400Zm320 0q-17 0-28.5-11.5T600-440q0-17 11.5-28.5T640-480q17 0 28.5 11.5T680-440q0 17-11.5 28.5T640-400ZM480-240q-17 0-28.5-11.5T440-280q0-17 11.5-28.5T480-320q17 0 28.5 11.5T520-280q0 17-11.5 28.5T480-240Zm-160 0q-17 0-28.5-11.5T280-280q0-17 11.5-28.5T320-320q17 0 28.5 11.5T360-280q0 17-11.5 28.5T320-240Zm320 0q-17 0-28.5-11.5T600-280q0-17 11.5-28.5T640-320q17 0 28.5 11.5T680-280q0 17-11.5 28.5T640-240Z"
                    />
                  </svg>
                </div>
                <div class="absolute inset-y-0 right-0 flex items-center pr-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 text-gray-400"
                    viewBox="0 -960 960 960"
                    fill="#e3e3e3"
                  >
                    <path
                      d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"
                    />
                  </svg>
                </div>
              </div>
            </div>

            <!-- Time -->
            <div>
              <label
                for="event-time"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Time
              </label>
              <div class="relative">
                <input
                  type="text"
                  id="event-time"
                  name="time"
                  required
                  class="w-full px-3 py-2 pl-8 pr-8 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                  placeholder="Select the Time"
                />
                <div class="absolute inset-y-0 left-0 flex items-center pl-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 text-gray-400"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                </div>
                <div class="absolute inset-y-0 right-0 flex items-center pr-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 text-gray-400"
                    viewBox="0 -960 960 960"
                    fill="#e3e3e3"
                  >
                    <path
                      d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"
                    />
                  </svg>
                </div>
              </div>
            </div>

            <!-- Location -->
            <div>
              <label
                for="event-location"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Location
              </label>
              <div class="relative">
                <input
                  type="text"
                  id="event-location"
                  name="location"
                  required
                  class="w-full px-3 py-2 pl-8 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                  placeholder="Select the Location"
                />
                <div class="absolute inset-y-0 left-0 flex items-center pl-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 text-gray-400"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 21s-6-5.373-6-10a6 6 0 1112 0c0 4.627-6 10-6 10z"
                    />
                    <circle cx="12" cy="11" r="2" />
                  </svg>
                </div>
                <div class="absolute inset-y-0 right-0 flex items-center pr-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 text-gray-400"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </div>
              </div>
            </div>

            <!-- Registration Fee -->
            <div>
              <label
                for="event-fee"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Registration Fee
              </label>
              <input
                type="number"
                id="event-fee"
                name="fee"
                min="0"
                step="100"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                placeholder="Enter The Registration Fee"
              />
            </div>

            <!-- Upload Image -->
            <div>
              <label
                for="event-image"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Upload the Image
              </label>
              <div class="relative">
                <input
                  type="file"
                  id="event-image"
                  name="image"
                  accept="image/*"
                  class="w-full px-3 py-2 pl-8 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                  placeholder="No file chosen"
                />
                <div class="absolute inset-y-0 left-0 flex items-center pl-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 text-gray-400"
                    viewBox="0 -960 960 960"
                    fill="#e3e3e3"
                  >
                    <path
                      d="M440-320v-326L336-542l-56-58 200-200 200 200-56 58-104-104v326h-80ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"
                    />
                  </svg>
                </div>
              </div>
            </div>

            <!-- Description -->
            <div>
              <label
                for="event-description"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Description
              </label>
              <textarea
                id="event-description"
                name="description"
                rows="4"
                required
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-none"
                placeholder="Enter the Text"
              ></textarea>
            </div>

            <!-- Submit Button -->
            <div class="pt-2">
              <button
                type="submit"
                class="w-full inline-flex items-center justify-center rounded-lg border-2 px-4 py-2 text-sm font-semibold focus:ring-2 focus:ring-offset-2"
                style="border-color: #340aff; color: #340aff"
                onmouseover="this.style.backgroundColor='#340AFF'; this.style.color='white';"
                onmouseout="this.style.backgroundColor='transparent'; this.style.color='#340AFF';"
              >
                Send
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </body>
</html>
